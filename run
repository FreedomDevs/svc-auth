#!/usr/bin/env bash
set -e

MODE="$1"
shift || true   # чтобы можно было передавать дополнительные аргументы, если нужно

BUILD_TYPE="Debug"
MARCH_NATIVE=""
GDB=0
CMAKE_ONLY=0

case "$MODE" in
    build)
        BUILD_TYPE="Release"
        ;;
    cmake)
        BUILD_TYPE="Debug"
        CMAKE_ONLY=1
        ;;
    run)
        BUILD_TYPE="Debug"
        GDB=1
        ;;
    *)
        echo "Unknown mode: $MODE"
        echo "Usage: $0 {build|native|cmake|run}"
        exit 1
        ;;
esac

cmake -G Ninja -S . -B build -DCMAKE_BUILD_TYPE=$BUILD_TYPE
if [[ $CMAKE_ONLY -eq 1 ]]; then
    exit
fi

cmake --build build -j$(nproc)

if [[ $GDB -eq 1 ]]; then
    cd build
    gdb --batch -ex run -ex bt -ex quit --args ./svc-auth
fi
